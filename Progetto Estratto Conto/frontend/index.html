<!doctype html>
<html lang="it">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Estratto Conto — ML Frontend</title>
    <!-- Bootstrap CSS (CDN) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      body { padding-top: 2rem; }
      .code { white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 class="mb-4">Estratto Conto - Esercizio pre compito in classe</h1>

      <div class="row g-4">

        <!-- TRAIN card -->
        <div class="col-md-6">
          <div class="card shadow-sm">
            <div class="card-body">
              <h5 class="card-title">Train con CSV</h5>
              <p class="card-text">Carica un CSV per addestrare il modello (usa /v1/train/upload).</p>
              <input id="trainFile" type="file" accept=".csv,text/csv" class="form-control mb-3" />
              <button id="btnTrain" class="btn btn-primary">Train</button>
              <div id="trainStatus" class="mt-3"></div>
            </div>
          </div>
        </div>

        <!-- PREDICT card -->
        <div class="col-md-6">
          <div class="card shadow-sm">
            <div class="card-body">
              <h5 class="card-title">Predict con CSV</h5>
              <p class="card-text">Carica un CSV per effettuare la predizione batch (usa /v1/predict/upload).</p>
              <input id="predictFile" type="file" accept=".csv,text/csv" class="form-control mb-3" />
              <button id="btnPredict" class="btn btn-success">Predict</button>
              <div id="predictStatus" class="mt-3"></div>
            </div>
          </div>
        </div>

       <!-- Preview + grafici -->
      <div class="col-12">
        <div class="card mt-3">
          <div class="card-body">
            <h5 class="card-title">Anteprima</h5>
            <div id="preview" class="code small mb-3"></div>

            <!-- Blocchi per grafici -->
            <div id="plots" class="row g-3"></div>
          </div>
        </div>
      </div>

    

    <!-- Bootstrap Bundle (JS) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Helper: post a CSV file to an upload endpoint
      async function postCsv(apiBase, endpoint, file) {
        const url = `${apiBase}${endpoint}`;
        const form = new FormData();
        form.append("file", file);

        const res = await fetch(url, { method: "POST", body: form });
        if (!res.ok) {
          const text = await res.text();
          throw new Error(`HTTP ${res.status}: ${text}`);
        }
        return res.json();
      }

      function setStatus(el, type, msg) {
        el.innerHTML = `<div class="alert alert-${type} mb-0" role="alert">${msg}</div>`;
      }

      function showPreview(obj) {
        const pre = document.getElementById("preview");
        pre.textContent = JSON.stringify(obj, null, 2);
      }

      function showPlots(plots) {
        const container = document.getElementById("plots");
        container.innerHTML = ""; // svuota contenitore

        if (!plots) return;

        const keys = Object.keys(plots);
        keys.forEach((key) => {
          const url = plots[key];
          const col = document.createElement("div");
          col.className = "col-md-6";
          col.innerHTML = `
            <div class="card shadow-sm">
              <img src="${url}" alt="${key}" class="card-img-top">
              <div class="card-body p-2">
                <p class="card-text text-center small mb-0">${key.replace("_", " ")}</p>
              </div>
            </div>
          `;
          container.appendChild(col);
        });
      }
      // TRAIN
      document.getElementById("btnTrain").addEventListener("click", async () => {
        const apiBase = document.getElementById("apiBase").value.trim();
        const fileInput = document.getElementById("trainFile");
        const status = document.getElementById("trainStatus");
        if (!fileInput.files.length) return setStatus(status, "warning", "Seleziona un CSV prima di eseguire il training.");

        setStatus(status, "info", "Caricamento in corso...");
        try {
          const data = await postCsv(apiBase, "/v1/train/upload", fileInput.files[0]);
          setStatus(status, "success", "Training completato ✅");
          showPreview(data);
          showPlots(data.plots);
          document.getElementById("plots").innerHTML = "";
        } catch (e) {
          setStatus(status, "danger", e.message);
        }
      });

      // PREDICT
      document.getElementById("btnPredict").addEventListener("click", async () => {
        const apiBase = document.getElementById("apiBase").value.trim();
        const fileInput = document.getElementById("predictFile");
        const status = document.getElementById("predictStatus");
        if (!fileInput.files.length) return setStatus(status, "warning", "Seleziona un CSV prima di eseguire le predizioni.");

        setStatus(status, "info", "Caricamento in corso...");
        try {
          const data = await postCsv(apiBase, "/v1/predict/upload", fileInput.files[0]);
          setStatus(status, "success", "Predizioni complete ✅");
          showPreview(data);
        } catch (e) {
          setStatus(status, "danger", e.message);
        }
      });
    </script>
  </body>
</html>